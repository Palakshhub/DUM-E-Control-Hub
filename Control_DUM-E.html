<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>DUM-E Control</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  background: #000;
  color: #fff;
  font-family: Arial, sans-serif;
  text-align: center;
  margin: 0;
}

h1 {
  color: red;
  margin: 15px 0;
}

button {
  background: red;
  color: black;
  border: none;
  padding: 12px 20px;
  margin: 8px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
}

button:active {
  background: darkred;
  color: white;
}

#joystick-container {
  width: 220px;
  height: 220px;
  background: #111;
  border-radius: 50%;
  margin: 20px auto;
  position: relative;
  border: 2px solid red;
}

#joystick {
  width: 70px;
  height: 70px;
  background: red;
  border-radius: 50%;
  position: absolute;
  top: 75px;
  left: 75px;
  touch-action: none;
}
</style>
</head>

<body>

<h1>DUM-E Control Hub</h1>

<button onclick="connectBLE()">CONNECT</button>

<div id="joystick-container">
  <div id="joystick"></div>
</div>

<div>
  <button onclick="sendCommand('SIT')">SIT</button>
  <button onclick="sendCommand('STAND')">STAND</button>
  <button onclick="sendCommand('WAVE')">WAVE</button>
</div>

<script>
let device, characteristic;
const SERVICE_UUID = "12345678-1234-1234-1234-1234567890ab";
const CHAR_UUID    = "abcdefab-1234-5678-1234-abcdefabcdef";

async function connectBLE() {
  device = await navigator.bluetooth.requestDevice({
    filters: [{ services: [SERVICE_UUID] }]
  });

  const server = await device.gatt.connect();
  const service = await server.getPrimaryService(SERVICE_UUID);
  characteristic = await service.getCharacteristic(CHAR_UUID);

  alert("Connected to ESP32");
}

function sendCommand(cmd) {
  if (!characteristic) return;
  const data = new TextEncoder().encode(cmd);
  characteristic.writeValue(data);
}

// -------- JOYSTICK LOGIC ----------
const joystick = document.getElementById("joystick");
const container = document.getElementById("joystick-container");

let dragging = false;
let lastCmd = "";

function handleMove(x, y) {
  const rect = container.getBoundingClientRect();
  const centerX = rect.width / 2;
  const centerY = rect.height / 2;

  const dx = x - rect.left - centerX;
  const dy = y - rect.top - centerY;

  const maxDist = 70;
  const dist = Math.min(Math.hypot(dx, dy), maxDist);
  const angle = Math.atan2(dy, dx);

  const nx = dist * Math.cos(angle);
  const ny = dist * Math.sin(angle);

  joystick.style.left = (centerX + nx - 35) + "px";
  joystick.style.top  = (centerY + ny - 35) + "px";

  let cmd = "";

  if (Math.abs(nx) > Math.abs(ny)) {
    cmd = nx > 0 ? "RIGHT" : "LEFT";
  } else {
    cmd = ny > 0 ? "BACKWARD" : "FORWARD";
  }

  if (cmd !== lastCmd) {
    sendCommand(cmd);
    lastCmd = cmd;
  }
}

function resetJoystick() {
  joystick.style.left = "75px";
  joystick.style.top  = "75px";
  sendCommand("STOP");
  lastCmd = "";
}

joystick.addEventListener("pointerdown", e => {
  dragging = true;
  joystick.setPointerCapture(e.pointerId);
});

document.addEventListener("pointermove", e => {
  if (dragging) handleMove(e.clientX, e.clientY);
});

document.addEventListener("pointerup", () => {
  if (dragging) {
    dragging = false;
    resetJoystick();
  }
});
</script>

</body>
</html>
