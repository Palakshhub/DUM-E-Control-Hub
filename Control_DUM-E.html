<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>DUM-E Control Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');

    html, body {
      height: 100%;
      width: 100%;
      overflow: hidden;
      font-family: 'Orbitron', sans-serif;
      background: #000 url('https://images8.alphacoders.com/126/thumbbig-1266469.webp') no-repeat center center fixed;
      background-size: cover;
      background-blend-mode: multiply;
    }

    .spider-card {
      width: 100vw;
      height: 100vh;
      background: rgba(255,255,255,0.08);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .controls {
      background: rgba(255,255,255,0.15);
      padding: 1.5rem;
      border-radius: 1rem;
      text-align: center;
    }

    .joystick-base {
      width: 120px;
      height: 120px;
      background: rgba(255,255,255,0.25);
      border-radius: 50%;
      position: relative;
      margin: auto;
      touch-action: none;
    }

    .joystick-stick {
      width: 60px;
      height: 60px;
      background: red;
      border-radius: 50%;
      position: absolute;
      top: 30px;
      left: 30px;
    }

    button:hover {
      transform: scale(1.08);
    }
  </style>
</head>

<body class="text-white">
  <main class="spider-card">
    <div class="controls space-y-4">
      <h1 class="text-3xl font-bold text-red-500">DUM-E Control Hub</h1>

      <button id="connectBtn" class="bg-blue-600 px-6 py-2 rounded-lg font-semibold">
        ðŸ”Œ Connect
      </button>

      <!-- JOYSTICK -->
      <div class="joystick-base" id="joystickBase">
        <div class="joystick-stick" id="joystickStick"></div>
      </div>

      <!-- BUTTONS -->
      <button id="sitBtn" class="bg-red-600 py-2 rounded-lg w-full">SIT</button>
      <button id="standBtn" class="bg-green-600 py-2 rounded-lg w-full">STAND</button>
      <button id="waveBtn" class="bg-purple-600 py-2 rounded-lg w-full">WAVE</button>
    </div>
  </main>

<script>
let txCharacteristic;
let espConnected = false;

const SERVICE_UUID = "12345678-1234-5678-1234-56789abcdef0";
const CHARACTERISTIC_UUID = "abcdef01-1234-5678-1234-56789abcdef0";

document.getElementById("connectBtn").onclick = async () => {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "DUM-E" }],
      optionalServices: [SERVICE_UUID]
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(SERVICE_UUID);
    txCharacteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);

    espConnected = true;
    alert("Connected âœ…");
  } catch (e) {
    alert("Connection failed âš ");
  }
};

function send(cmd) {
  if (!espConnected) return;
  txCharacteristic.writeValue(new TextEncoder().encode(cmd));
}

/* BUTTON COMMANDS */
sitBtn.onclick   = () => send("SIT");
standBtn.onclick = () => send("STAND");
waveBtn.onclick  = () => send("WAVE");

/* JOYSTICK LOGIC */
const base = joystickBase;
const stick = joystickStick;
const maxDist = 40;
let active = false;

function centerStick() {
  stick.style.left = "30px";
  stick.style.top  = "30px";
  send("STOP");
}

function moveStick(x, y) {
  const rect = base.getBoundingClientRect();
  let dx = x - rect.left - 60;
  let dy = y - rect.top  - 60;

  const dist = Math.hypot(dx, dy);
  if (dist > maxDist) {
    dx = dx * maxDist / dist;
    dy = dy * maxDist / dist;
  }

  stick.style.left = 30 + dx + "px";
  stick.style.top  = 30 + dy + "px";

  if (Math.abs(dx) > Math.abs(dy)) {
    send(dx > 0 ? "RIGHT" : "LEFT");
  } else {
    send(dy > 0 ? "BACKWARD" : "FORWARD");
  }
}

base.onmousedown = () => active = true;
window.onmousemove = e => active && moveStick(e.clientX, e.clientY);
window.onmouseup = () => { active = false; centerStick(); };

base.ontouchstart = () => active = true;
base.ontouchmove = e => {
  const t = e.touches[0];
  moveStick(t.clientX, t.clientY);
};
base.ontouchend = () => { active = false; centerStick(); };
</script>
</body>
</html>
